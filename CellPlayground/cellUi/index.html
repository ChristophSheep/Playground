<html>
<head>
    <script type="text/javascript">

        var paper;
        var size;

        function init() {
            paper = getPaper()
            size  = getSize() 

            // Default
            paper.pointSize = 1.0

            paper.DEBUG = true

            // Start animation
            window.requestAnimationFrame(draw)
        }

        function getPaper() {
            return document.getElementById("scene").getContext("2d")
        }

        function getSize() {
            width  = document.getElementById("scene").width
            height = document.getElementById("scene").height
            return {width:width,height:height}
        }

        //
        // HELPERS
        //
        function deg2rad(x) {
            return (x/180.0) * Math.PI
        }

        function clamp(min,max,val) {
            if (val < min) {
                val = 0
            }
            if (val > max) {
                val = 100
            }
            return val
        }

        function polar(radius,alpha) {
            x = radius*Math.cos(deg2rad(alpha))
            y = radius*Math.sin(deg2rad(alpha))
            return {x:x,y:y}
        }

        //
        // SHAPES
        //

        function point(pt) {
            return function() {
                //console.debug("pointSize:"+paper.pointSize)
                paper.beginPath()
                paper.arc(pt.x, pt.y, paper.pointSize, 0, Math.PI *2, true)
                paper.fill()
                paper.stroke()
            }
        }

        function circle(r) {
            return function() {
                paper.beginPath()
                paper.arc(0, 0, r, 0, Math.PI *2, true)
                paper.fill()
                paper.stroke()
            };
        }

        function arc(r, a, b) {
            return function() {
                paper.beginPath()
                paper.arc(0, 0, r, deg2rad(a), deg2rad(b), false)
                paper.stroke()
            }
        }
 
        function rect(w, h) {
            return function() {
                paper.fillRect  (-w/2, -h/2, w, h)
                paper.strokeRect(-w/2, -h/2, w, h)
            }
        }

        function line(p1,p2) {
            return function() {
                paper.beginPath()
                paper.moveTo(p1.x,p1.y)
                paper.lineTo(p2.x,p2.y)
                paper.stroke()
            }
        }

        function polyline(pts) {
            return function() {
                paper.beginPath()
                pts.forEach(function(pt,i){
                    if (i === 0) {
                        paper.moveTo(pt.x,pt.y)
                    } else {
                        paper.lineTo(pt.x,pt.y)
                    }
                })
                paper.stroke()
            }
        }

        function bezCurve(p1,cp1,cp2,p2) {

            curve = [
                function() {
                    paper.beginPath()
                    paper.moveTo(p1.x,p1.y)
                    paper.bezierCurveTo(cp1.x,cp1.y,cp2.x,cp2.y,p2.x,p2.y)
                    paper.stroke()
                }, 
            ]

            if (paper.DEBUG) {

                st = {strokeColor:'lightgrey'}
                sp = {strokeColor:'blue', fillColor: 'blue', pointSize: 1.2}

                tangents = [
                    style( 
                        st,
                        line(p1,cp1),
                    ),
                    style(
                        st,
                        line(cp2,p2),
                    ),
                    style(sp,
                        point(cp1)
                    ),
                    style(sp,
                        point(cp2)
                    ),
                ]

                curve = tangents.concat(curve)
            }

            return group(curve)
        }

        function quadCurve(p1,cp,p2) {
            curve = [function() {
                paper.beginPath()
                paper.moveTo(p1.x,p1.y)
                paper.quadraticCurveTo(cp.x,cp.y,p2.x,p2.y)
                paper.stroke()
            }]

            if (paper.DEBUG) {

                st = {strokeColor:'lightgrey'}
                sp = {strokeColor:'blue', fillColor: 'blue', pointSize: 1.2}

                tangents = [
                    style(st,
                        line(p1,cp),
                    ),
                    style(st,
                        line(cp,p2),
                    ),
                    style(sp,
                        point(cp)
                    ),
                ]
                curve = tangents.concat(curve)  
            }

            return group(curve)
        }

        function text(str) {
            return function() {
                paper.fillText(str, 0, 0)
                paper.strokeText(str, 0, 0)
            }
        }

        //
        // MODIFIERS
        //
        function group(fns) {
            return function() {
                fns.forEach(function(fn) {
                    fn()        
                })
            }
        }

        function transform(t, fn) {
            return function() {
                paper.save()
                    paper.translate(t.x,  t.y )
                    paper.scale    (t.sx, t.sy)
                    fn()
                paper.restore()
            }
        }

        function style(s, fn) {
            return function() {
                savedPointSize = paper.pointSize
                paper.save()
                    paper.font         = s.font
                    paper.textAlign    = s.textAlign
                    paper.textBaseline = s.testBaseline
                    paper.fillStyle    = s.fillColor
                    paper.strokeStyle  = s.strokeColor
                    paper.lineWidth    = s.lineWidth
                    paper.pointSize    = s.pointSize
                    fn()
                paper.restore()
                paper.pointSize = savedPointSize
            }
        }

        //
        // Cell components
        //

        // Cell background
        //
        function background(radius) {
            return circle(radius)
        }

        // Dendride (area)
        //
        function drendride(radius, percent) {

            percent = clamp(0,100,percent)
            
            alpha = 40
            width = radius*0.25

            alphaFull    = 360-alpha*2
            alphaPercent = (alphaFull*percent/100)

            alphaEnd     = 360-alpha
            alphaStart   = alphaEnd - alphaPercent 

            return group([
                // percentage
                style(
                    {lineWidth:width},
                    arc(radius-width/2, alphaStart, alphaEnd)
                ),
                // borders
                style(
                    {lineWidth:width},
                    arc(radius-width/2, alpha, alpha+1)
                ),
                style(
                    {lineWidth:width},
                    arc(radius-width/2, alphaEnd-1, alphaEnd)
                ),
                arc(radius-width, alpha, alphaEnd)
            ])     
        }

        // Cell body / soma
        //
        function soma(radius, percent) {
            fontSize = radius * 0.5
            radius = 3 + radius*0.5 * percent/100
            str = percent+''

            txt = style({
                    fillColor:'white',
                    strokeColor:'white',
                    textAlign:'center',
                    font: fontSize+'px Arial',
                },
                text(str)
            )

            kernel = style(
                {fillColor:"blue", lineWidth:2},
                circle(radius)
            )

            return group([
                kernel,
                transform({x:0,y:fontSize/4},
                    txt
                )
            ])
        }

        // Axon
        //
        function axon(radius, percent) {

            function getColor(percent) {
                if (percent < 95) {
                    fillColorColor = "lightblue"
                } else {
                    fillColorColor = "blue"
                }
                return fillColorColor
            }

            length = 120
            fillColorColor = getColor(percent)
            return transform(
                {x:radius,y:0},
                style(
                    {fillColor:fillColorColor},
                    group([
                        transform(
                            {x:length/2,y:0},
                            rect(length,radius*0.1)
                        ),
                        circle(radius*0.15),
                    ])
                )
            )
        }

     
        // Synapse
        //
        function synapse(radius, weight, alpha) {
            function getWeightedRadius(radius, weight) {
                return radius*weight
            }

            fact = 0.05
            pos = polar(radius,alpha)
            radius = radius*fact
            return transform(
                pos,
                style(
                    {fillColor:"blue"},
                    circle(getWeightedRadius(radius,weight))
                )
            )
        }

        // TODO: use point and style
        function point2(pt) {
            return transform(
                pt,
                style(
                    {fillColor:"blue"},
                    circle(radius*0.03)
                )
            )
        }

        function connection(radius, weight, alpha) {
            p2 = polar(radius,alpha)
            cp = polar(radius*1.5,alpha)
            p1 = polar(radius*1.5,alpha)
            p1.x = - 150
            return group([
                quadCurve(p1,cp,p2),
                //point2(cp),
                synapse(radius,weight,alpha),
            ])
        }

        function cell(radius,s,percent) {
            // TODO: List of connections
            return style(s,
                group([
                    connection(radius, 2.0, 360-120),
                    connection(radius, 1.5, 190),
                    connection(radius, 0.8, 120),                
                    axon(radius,percent),
                    background(radius),
                    drendride(radius, percent),
                    soma(radius, percent)
                ])
            )
        }

        // Diagram (action potential)
        //
        function diagram() {

            function curve() {
                
                // 0 - 50
                p1  = {x: 0, y: 0}
                cp1 = {x:10, y: 0}
                cp2 = {x:50, y: 0}
                p2  = {x:50, y:15}

                // 50 - 60 = 10
                p3 = p2
                cp3 = {x:50, y: 0}
                cp4 = {x:55, y:100}
                p4  = {x:60, y:100}
            
                // 70 - 80 = 10
                p5 = p4
                cp5 = {x:65, y:100}
                cp6 = {x:75, y:-15}
                p6  = {x:80, y:-15}

                // 80 - 150 = 50
                p7 = p6
                cp7 = {x:100, y:-20}
                cp8 = {x:100, y:  0}
                p8  = {x:130, y:  0}

                return group([
                    bezCurve(p1, cp1, cp2, p2),
                    bezCurve(p3, cp3, cp4, p4),
                    bezCurve(p5, cp5, cp6, p6),
                    bezCurve(p7, cp7, cp8, p8),   
                ])
            }

            function threshold() {
                p1 = {x:0,  y:15}
                p2 = {x:150,y:15}
                return line(p1,p2)
            }

            function axis() {
                xsize = 150
                ysize = 120
                
                p0 = {x:0,    y:    0}
                py = {x:0,    y:ysize}
                px = {x:xsize,y:    0}
                
                return polyline([py,p0,px])
            }

            return group([
                style(
                    {strokeColor:'grey', lineWidth:1},
                    axis()
                ),
                style(
                    {strokeColor:'blue'},
                    curve()
                ),
                style(
                    {strokeColor:'green'},
                    threshold()
                )
            ])
        }

        // Clear scene
        //
        function clear() {
            //paper.fillStyle = 'rgba(255,255,255,0.3)'
            //paper.fillRect(0,0,size.width,size.height);
        
            paper.clearRect(0,0,size.width,size.height); 
        }
        // Draw scene
        //
        function draw() {

            // TODO: check
            // paper.globalCompositeOperation = 'destination-over';
            
            clear()

            var s = {
                fillColor  : "lightgrey",
                strokeColor: "blue", // default
                lineWidth: 1,
            }

            var t = {
                x : 70,
                y : 70,
                sx: 1.0,
                sy: 1.0,
            }

            // transformNode (warp)
            // styleNode     (wrap)
            // shapeNode     (circle, rect, arc)

            radius = 70
            now = new Date()
            percent = Math.trunc(now.getMilliseconds()/10)

            var c = transform({
                     x:size.width /2
                    ,y:size.height/2
                },
                cell(radius,s,percent)
            )

            var d = transform({
                     x: 320,
                     y: 470,
                    sx:   1,
                    sy:  -1, // (0,0) lower left
                },
                diagram(s)
            )
            
            group([
                c,
                d
            ])()
                       
            // Next loop
            // window.requestAnimationFrame(draw)
        }
    </script>
</head>
<body onload="init();draw();">
    <h1>Scene</h1>
    <canvas id="scene" width="500" height="500" style="border:1px solid grey"></canvas>
</body>
</html>
