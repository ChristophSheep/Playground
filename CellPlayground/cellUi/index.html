<html>
<head>
    <script type="text/javascript">

        var paper;

        function init() {
            paper = getCtx();
            window.requestAnimationFrame(draw);
        }

        function getCtx() {
            return document.getElementById("scene").getContext("2d")
        }
        //
        // HELPERS
        //
        function deg2rad(x) {
            return (x/180.0) * Math.PI;
        }
        //
        // SHAPES
        //
        function circle(r) {
            return function() {
                paper.beginPath();
                paper.arc(0, 0, r, 0, Math.PI *2, true);
                paper.fill();
                paper.stroke();
            };
        }

        function arc(r, a, b) {
            return function() {
                paper.beginPath();
                paper.arc(0, 0, r, deg2rad(a), deg2rad(b), false);
                paper.stroke();
            };
        }
 
        function rect(w, h) {
            return function() {
                paper.fillRect  (-w/2, -h/2, w, h);
                paper.strokeRect(-w/2, -h/2, w, h); 
            };
        }
        //
        // MODIFIERS
        //
        function group(fns) {
            return function() {
                fns.forEach(
                    function(fn) {
                        fn()
                    }
                )
            }
        }

        function transform(t, fn) {
            return function() {
                paper.save()
                    paper.translate(t.x, t.y)
                    paper.scale(t.sx, t.sy)
                    fn()
                paper.restore()
            }
        }

        function style(s, fn) {
            return function() {
                paper.save();
                    paper.fillStyle   = s.fill;
                    paper.strokeStyle = s.stroke;
                    paper.lineWidth   = s.strokeWidth;
                    fn()
                paper.restore()
            }
        }

        // Cell components
        //
        function background(radius) {
            return transform(
                {x:0,y:0},
                style(
                    {fill:"lightgrey", stroke:"blue", strokeWidth:1},
                    circle(radius)
                )
            )
        }

        function clamp(min,max,val) {
            if (val < min) {
                val = 0
            }
            if (val > max) {
                val = 100
            }
            return val
        }

        function drendride(radius, percent) {

            percent = clamp(0,100, percent)
            
            alpha = 40
            width = radius*0.25

            length = 360-2*alpha
            alphaEnd = 360-alpha
            alphaStart = alphaEnd - (length*percent/100) 

            return group([
                    style(
                        {strokeWidth:width},
                        arc(radius-width/2, alphaStart, alphaEnd)
                    ),
                    style(
                        {strokeWidth:width},
                        arc(radius-width/2, alpha, alpha+1)
                    ),
                    style(
                        {strokeWidth:width},
                        arc(radius-width/2, alphaEnd-1, alphaEnd)
                    ),
                    arc(radius-width, alpha, alphaEnd)
                ])     
        }

        function soma(radius, percent) {
            radius = radius*0.5 * percent/100
            return style(
                {fill:"lightblue", stroke:"blue", strokeWidth:2},
                circle(radius)
            )
        }

        function axon(radius, percent) {
            length = 120
            if (percent < 95) {
                fillColor = "lightblue"
            } else {
                fillColor = "blue"
            }
            return transform(
                {x:radius,y:0},
                style(
                    {fill:fillColor, stroke:"blue", strokeWidth:1},
                    group([
                        transform(
                            {x:length/2,y:0},
                            rect(length,5)
                        ),
                        circle(5),
                    ])
                )
            )
        }

        function cell(radius,s, percent) {
            alpha = 40
            return style(s,
                group([
                    axon(radius,percent),
                    background(radius),
                    drendride(radius, percent),
                    soma(radius, percent),
                ])
            )
        }

        //
        // DRAW
        //
        function draw() {

            //paper.globalCompositeOperation = 'destination-over';
            paper.clearRect(0,0,500,500);
         
            var s = {
                fill: "rgba(0,255,128,0.5)",
                stroke: "blue", // default
                strokeWidth: 1,
            }

            var t = {
                x : 70,
                y : 70,
                sx: 1.0,
                sy: 1.0,
            }

            // transformNode (warp)
            // styleNode     (wrap)
            // shapeNode     (circle, rect, arc)

            time = new Date()
            radius = 70
            alpha = 50
            percent = time.getMilliseconds()/10

            var drawCell = transform(
                {x:250,y:250},
                cell(radius,s, percent)
            )
            drawCell()
         
            window.requestAnimationFrame(draw);
            
        }
    </script>
</head>
<body onload="init();draw();">
    <h1>Scene</h1>
    <canvas id="scene" width="500" height="500" style="border:1px solid grey"></canvas>
</body>
</html>
