<html>
<head>
    <script type="text/javascript">

        var paper;
        var size;

        function init() {
            paper = getPaper()
            size  = getSize() 
            // Start animation
            window.requestAnimationFrame(draw)
        }

        function getPaper() {
            return document.getElementById("scene").getContext("2d")
        }

        function getSize() {
            width  = document.getElementById("scene").width
            height = document.getElementById("scene").height
            return {width:width,height:height}
        }

        //
        // HELPERS
        //
        function deg2rad(x) {
            return (x/180.0) * Math.PI
        }

        function clamp(min,max,val) {
            if (val < min) {
                val = 0
            }
            if (val > max) {
                val = 100
            }
            return val
        }

        function polar(radius,alpha) {
            x = radius*Math.cos(deg2rad(alpha))
            y = radius*Math.sin(deg2rad(alpha))
            return {x:x,y:y}
        }

        //
        // SHAPES
        //
        function circle(r) {
            return function() {
                paper.beginPath()
                paper.arc(0, 0, r, 0, Math.PI *2, true)
                paper.fill()
                paper.stroke()
            };
        }

        function arc(r, a, b) {
            return function() {
                paper.beginPath()
                paper.arc(0, 0, r, deg2rad(a), deg2rad(b), false)
                paper.stroke()
            }
        }
 
        function rect(w, h) {
            return function() {
                paper.fillRect  (-w/2, -h/2, w, h)
                paper.strokeRect(-w/2, -h/2, w, h)
            }
        }

        function bezCurve(p1,cp1,cp2,p2) {
            return function() {
                paper.beginPath()
                paper.moveTo(p1.x,p1.y)
                paper.bezierCurveTo(cp1.x,cp1.y,cp2.x,cp2.y,p2.x,p2.y)
                paper.stroke()
            }
        }

        function quadCurve(p1,cp,p2) {
            return function() {
                paper.beginPath()
                paper.moveTo(p1.x,p1.y)
                paper.quadraticCurveTo(cp.x,cp.y,p2.x,p2.y)
                paper.stroke()
            }
        }

        function text(str) {
            return function() {
                paper.fillText(str, 0, 0)
                paper.strokeText(str, 0, 0)
            }
        }

        //
        // MODIFIERS
        //
        function group(fns) {
            return function() {
                fns.forEach(
                    function(fn) {
                        fn()
                    }
                )
            }
        }

        function transform(t, fn) {
            return function() {
                paper.save()
                    paper.translate(t.x,  t.y )
                    paper.scale    (t.sx, t.sy)
                    fn()
                paper.restore()
            }
        }

        function style(s, fn) {
            return function() {
                paper.save()
                    paper.font         = s.font
                    paper.textAlign    = s.textAlign
                    paper.textBaseline = s.testBaseline
                    paper.fillStyle    = s.fillColor
                    paper.strokeStyle  = s.strokeColor
                    paper.lineWidth    = s.strokeColorWidth
                    fn()
                paper.restore()
            }
        }

        // Cell components
        //
        function background(radius) {
            return circle(radius)
        }

        function drendride(radius, percent) {

            percent = clamp(0,100,percent)
            
            alpha = 40
            width = radius*0.25

            alphaFull    = 360-alpha*2
            alphaPercent = (alphaFull*percent/100)

            alphaEnd     = 360-alpha
            alphaStart   = alphaEnd - alphaPercent 

            return group([
                // percentage
                style(
                    {strokeColorWidth:width},
                    arc(radius-width/2, alphaStart, alphaEnd)
                ),
                // borders
                style(
                    {strokeColorWidth:width},
                    arc(radius-width/2, alpha, alpha+1)
                ),
                style(
                    {strokeColorWidth:width},
                    arc(radius-width/2, alphaEnd-1, alphaEnd)
                ),
                arc(radius-width, alpha, alphaEnd)
            ])     
        }

        function soma(radius, percent) {
            fontSize = radius * 0.5
            radius = 3 + radius*0.5 * percent/100
            str = percent+''

            txt = style({
                    fillColor:'white',
                    strokeColor:'white',
                    textAlign:'center',
                    font: fontSize+'px sans serif',
                },
                text(str)
            )

            kernel = style(
                {fillColor:"blue", strokeColorWidth:2},
                circle(radius)
            )

            return group([
                kernel,
                transform({x:0,y:fontSize/4},
                    txt
                )
            ])
        }

   
        function axon(radius, percent) {

            function getColor(percent) {
                if (percent < 95) {
                    fillColorColor = "lightblue"
                } else {
                    fillColorColor = "blue"
                }
                return fillColorColor
            }

            length = 120
            fillColorColor = getColor(percent)
            return transform(
                {x:radius,y:0},
                style(
                    {fillColor:fillColorColor},
                    group([
                        transform(
                            {x:length/2,y:0},
                            rect(length,radius*0.1)
                        ),
                        circle(radius*0.15),
                    ])
                )
            )
        }

        function getWeightedRadius(radius, weight) {
            return radius*weight
        }

        function synapse(radius, weight, alpha) {
            fact = 0.05
            pos = polar(radius,alpha)
            radius = radius*fact
            return transform(
                pos,
                style(
                    {fillColor:"blue"},
                    circle(getWeightedRadius(radius,weight))
                )
            )
        }

        function point(pt) {
            return transform(
                pt,
                style(
                    {fillColor:"blue"},
                    circle(radius*0.05)
                )
            )
        }

        function connection(radius, weight, alpha) {
            p2 = polar(radius,alpha)
            cp = polar(radius*1.5,alpha)
            p1 = polar(radius*1.5,alpha)
            p1.x = - 150
            return group([
                quadCurve(p1,cp,p2),
                //point(cp),
                synapse(radius,weight,alpha),
            ])
        }

        function cell(radius,s,percent) {
            // TODO: List of connections
            return style(s,
                group([
                    connection(radius, 2.0, 360-120),
                    connection(radius, 1.5, 190),
                    connection(radius, 0.8, 120),                
                    axon(radius,percent),
                    background(radius),
                    drendride(radius, percent),
                    soma(radius, percent)
                ])
            )
        }

        //
        // DRAW
        //
        function draw() {

            //paper.globalCompositeOperation = 'destination-over';
            paper.clearRect(0,0,size.width,size.height);
         
            var s = {
                fillColor  : "lightgrey",
                strokeColor: "blue", // default
                strokeColorWidth: 1,
            }

            var t = {
                x : 70,
                y : 70,
                sx: 1.0,
                sy: 1.0,
            }

            // transformNode (warp)
            // styleNode     (wrap)
            // shapeNode     (circle, rect, arc)

            time = new Date()
            radius = 70
            alpha = 50
            percent = Math.round(time.getMilliseconds()/10)

            var drawCell = transform(
                {x:size.width/2,y:size.height/2},
                cell(radius,s,percent)
            )
            drawCell()

            // Next loop
            window.requestAnimationFrame(draw)
        }
    </script>
</head>
<body onload="init();draw();">
    <h1>Scene</h1>
    <canvas id="scene" width="500" height="500" style="border:1px solid grey"></canvas>
</body>
</html>
