<html>
<head>
    <script type="text/javascript">

        var paper;
        var size;

        function init() {
            paper = getPaper()
            size  = getSize() 
            // Start animation
            window.requestAnimationFrame(draw)
        }

        function getPaper() {
            return document.getElementById("scene").getContext("2d")
        }

        function getSize() {
            width  = document.getElementById("scene").width
            height = document.getElementById("scene").height
            return {width:width,height:height}
        }

        //
        // HELPERS
        //
        function deg2rad(x) {
            return (x/180.0) * Math.PI
        }

        function clamp(min,max,val) {
            if (val < min) {
                val = 0
            }
            if (val > max) {
                val = 100
            }
            return val
        }

        //
        // SHAPES
        //
        function circle(r) {
            return function() {
                paper.beginPath()
                paper.arc(0, 0, r, 0, Math.PI *2, true)
                paper.fill()
                paper.stroke()
            };
        }

        function arc(r, a, b) {
            return function() {
                paper.beginPath()
                paper.arc(0, 0, r, deg2rad(a), deg2rad(b), false)
                paper.stroke()
            }
        }
 
        function rect(w, h) {
            return function() {
                paper.fillRect  (-w/2, -h/2, w, h)
                paper.strokeRect(-w/2, -h/2, w, h)
            }
        }

        function bezier(cp1x,cp1y,cp2x,cp2y,x,y) {
            return function() {
                paper.beginPath()
                paper.bezierCurveTo(cp1x,cp1y,cp2x,cp2y,x,y)
                paper.stroke()
            }
        }

        //
        // MODIFIERS
        //
        function group(fns) {
            return function() {
                fns.forEach(
                    function(fn) {
                        fn()
                    }
                )
            }
        }

        function transform(t, fn) {
            return function() {
                paper.save()
                    paper.translate(t.x, t.y)
                    paper.scale(t.sx, t.sy)
                    fn()
                paper.restore()
            }
        }

        function style(s, fn) {
            return function() {
                paper.save();
                    paper.fillStyle   = s.fill;
                    paper.strokeStyle = s.stroke;
                    paper.lineWidth   = s.strokeWidth;
                    fn()
                paper.restore()
            }
        }

        // Cell components
        //
        function background(radius) {
            return circle(radius)
        }

        function drendride(radius, percent) {

            percent = clamp(0,100,percent)
            
            alpha = 40
            width = radius*0.25

            alphaFull    = 360-alpha*2
            alphaPercent = (alphaFull*percent/100)

            alphaEnd     = 360-alpha
            alphaStart   = alphaEnd - alphaPercent 

            return group([
                // percentage
                style(
                    {strokeWidth:width},
                    arc(radius-width/2, alphaStart, alphaEnd)
                ),
                // borders
                style(
                    {strokeWidth:width},
                    arc(radius-width/2, alpha, alpha+1)
                ),
                style(
                    {strokeWidth:width},
                    arc(radius-width/2, alphaEnd-1, alphaEnd)
                ),
                arc(radius-width, alpha, alphaEnd)
            ])     
        }

        function soma(radius, percent) {
            radius = 3 + radius*0.5 * percent/100
            return style(
                {fill:"blue", strokeWidth:2},
                circle(radius)
            )
        }

        function getColor(percent) {
            if (percent < 95) {
                fillColor = "lightblue"
            } else {
                fillColor = "blue"
            }
            return fillColor
        }

        function axon(radius, percent) {
            length = 120
            fillColor = getColor(percent)
            return transform(
                {x:radius,y:0},
                style(
                    {fill:fillColor},
                    group([
                        transform(
                            {x:length/2,y:0},
                            rect(length,radius*0.1)
                        ),
                        circle(radius*0.15),
                    ])
                )
            )
        }

        function cell(radius,s,percent) {
            alpha = 40
            return style(s,
                group([
                    axon(radius,percent),
                    background(radius),
                    drendride(radius, percent),
                    soma(radius, percent),
                    bezier(-200,-100,-75,-100,0,0),
                    bezier(-200,+100,-75,+100,0,0),
                ])
            )
        }

        //
        // DRAW
        //
        function draw() {

            //paper.globalCompositeOperation = 'destination-over';
            paper.clearRect(0,0,size.width,size.height);
         
            var s = {
                fill  : "lightgrey",
                stroke: "blue", // default
                strokeWidth: 1,
            }

            var t = {
                x : 70,
                y : 70,
                sx: 1.0,
                sy: 1.0,
            }

            // transformNode (warp)
            // styleNode     (wrap)
            // shapeNode     (circle, rect, arc)

            time = new Date()
            radius = 70
            alpha = 50
            percent = time.getMilliseconds()/10

            var drawCell = transform(
                {x:size.width/2,y:size.height/2},
                cell(radius,s, percent)
            )
            drawCell()

            // Next loop
            //window.requestAnimationFrame(draw)
        }
    </script>
</head>
<body onload="init();draw();">
    <h1>Scene</h1>
    <canvas id="scene" width="500" height="500" style="border:1px solid grey"></canvas>
</body>
</html>
